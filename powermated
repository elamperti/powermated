#!/usr/bin/env python

from subprocess import call
from evdev import InputDevice, ecodes
import sys
import errno

VOLUME_CMD = ['amixer', '-D', 'pulse', 'sset', 'Master']
MUTE_CMD = ['amixer', '-D', 'pulse', 'sset', 'Master', 'toggle']


def run(device):

    """
    Monitor the given device and modify the sound volume

    :param device: the name of the device to read
    """

    try:
        for event in InputDevice(device).read_loop():

            # event action: mute
            if event.type == ecodes.EV_KEY:

                if event.value == 1:
                    call(MUTE_CMD)

            # event action: volume
            elif event.type == ecodes.EV_REL:

                cmd = VOLUME_CMD[:]
                cmd.append(str(abs(event.value)) + '%')

                if event.value > 0:
                    cmd[-1] += '+'
                else:
                    cmd[-1] += '-'

                call(cmd)

    except IOError, e:
        # terminate silently on device disconnected
        if e.errno == errno.ENODEV:
            pass
        else:
            raise e

    # terminate silently on Ctrl-C
    except KeyboardInterrupt:
        pass


if __name__ == "__main__":

    if len(sys.argv) < 2:
        print 'Usage: powermated <device>'
        sys.exit()

    run(sys.argv[1])
